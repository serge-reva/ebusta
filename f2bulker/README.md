# f2bulker: Высокопроизводительный индексатор FB2 в OpenSearch

## 1. Спецификация требований (ISO 29148)

Данный раздел формализует требования к системе, обеспечивая их проверяемость и соответствие техническим целям проекта.

### 1.1 Функциональные требования (Functional Requirements)
* **FR-1: Извлечение из ZIP.** Система должна открывать ZIP-архивы и извлекать файлы формата `.fb2`.
* **FR-2: Парсинг метаданных.** Программа должна извлекать название книги и список авторов из структуры FB2.
* **FR-3: Отказоустойчивость.** При ошибках XML-парсинга система должна применять поиск через регулярные выражения.
* **FR-4: Формат Bulk API.** Вывод должен формироваться в формате JSONL, пригодном для Bulk API OpenSearch, включая строку метаданных индекса и строку документа.
* **FR-5: Дедупликация.** Система должна рассчитывать SHA1-хеш каждого файла и пропускать уже обработанные объекты на основе анализа выходного файла.
* **FR-6: Режим Fast-skip.** При установленном флаге `-fast` система должна мгновенно пропускать контейнер, если соответствующий ему `.jsonl` файл существует и не пуст.
* **FR-7: Управление через CLI.** Программа должна поддерживать флаги `-config`, `-container`, `-rescan`, `-verbose`, `-fast`.
* **FR-8: Интеграция со скриптами.** Программа должна возвращать код завершения `10` при пропуске обработанного контейнера для корректной работы внешних планировщиков.

### 1.2 Нефункциональные требования (Performance & Quality)
* **PR-1: Параллелизм.** Обработка должна распределяться между потоками (горутинами) согласно параметру `Threads` в конфигурации.
* **PR-2: Оптимизация Discovery.** Для новых контейнеров этап подготовки задач не должен включать чтение содержимого файлов в основном потоке.
* **PR-3: Эффективность памяти.** Содержимое файлов должно очищаться из RAM сразу после записи в выходной файл.
* **PR-4: Поддержка кодировок.** Система должна корректно обрабатывать UTF-8, UTF-16 и Windows-1251.

---

## 2. Документ технической реализации

### 2.1 Архитектура системы
Программа построена на модели **Concurrent Worker Pool** (Пул параллельных воркеров).



#### Компоненты потока управления:
1.  **Главный поток (Producer):** Сканирует архивы и формирует очередь задач.
2.  **Канал задач (`jobs`):** Буферизированный канал для передачи структур `workItem`.
3.  **Воркеры (Consumers):** Набор из N горутин, выполняющих параллельное чтение, хеширование и парсинг.
4.  **Синхронизатор:** `sync.WaitGroup` для контроля завершения всех процессов перед выходом.

### 2.2 Пошаговая передача управления
1.  **`main` → `processSingleZip`:** Инициализация параметров конкретного контейнера.
2.  **Проверка Fast-skip:** Если флаг `-fast` активен, управление через `os.Stat` проверяет наличие файла. При успехе — немедленный выход через `os.Exit(10)`.
3.  **Discovery (Оптимизированный):** * Если база хешей пуста (новый контейнер), основной поток лишь заполняет список `tasks` ссылками на `zip.File`, минуя вызовы `f.Open` и `io.ReadAll`.
    * Это устраняет "зависание" программы перед появлением прогресс-бара.
4.  **Развертывание воркеров:** Основной поток передает задачи в канал. Управление внутри воркера реализует **Lazy Loading**: если данные файла отсутствуют (`item.raw == nil`), воркер сам инициирует чтение и расчет SHA1 параллельно с другими воркерами.
5.  **Завершение:** После закрытия канала воркеры завершают работу, и управление возвращается в `main` для перехода к следующему ZIP-архиву.

### 2.3 Жизненный цикл переменных
* **`item.raw` ([]byte):** Данные файла. Память выделяется либо в Discovery, либо в воркере. Ссылка на массив байтов обнуляется сразу после вызова `saveToOutputWithSha`, что позволяет Garbage Collector (GC) освобождать память итеративно.
* **`existingHashes` (map):** Карта хешей. Загружается один раз в начале обработки ZIP для дедупликации. При ее отсутствии активируется режим ускоренного Discovery.
* **`err`:** Все переменные ошибок проходят аудит; при критических сбоях (например, невозможность открыть файл вывода) программа завершается через `log.Fatalf`.

### 2.4 Матрица состояний (Аудит логики `-fast`)

| Режим `-fast` | Состояние контейнера | Логика | Результат |
| :--- | :--- | :--- | :--- |
| **Установлен** | **Обработан** | `os.Stat` находит файл | Мгновенный выход `Exit(10)`. |
| **Установлен** | **Не обработан** | `os.Stat` возвращает ошибку | Быстрый Discovery -> Параллельное хеширование. |
| **Не установлен** | **Обработан** | Сравнение счетчиков файлов | Выход `Exit(10)`, если количество совпадает. |
| **Не установлен** | **Не обработан** | База хешей пуста | Быстрый Discovery -> Параллельное хеширование. |

---

## 3. Инструкции по эксплуатации

### Сборка
```bash
make build
