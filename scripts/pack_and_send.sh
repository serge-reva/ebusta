#!/bin/bash

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–µ—Ä–µ–¥–∞–Ω–æ –ª–∏ –∏–º—è —Ñ–∞–π–ª–∞
if [ -z "$1" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –£–∫–∞–∂–∏—Ç–µ –∏–º—è —Ä–µ–∑—É–ª—å—Ç–∏—Ä—É—é—â–µ–≥–æ —Ñ–∞–π–ª–∞."
    echo "–ü—Ä–∏–º–µ—Ä: ./scripts/pack_and_send.sh project_context.txt"
    exit 1
fi

RESULT_FILE="$1"
TARGET="reva@mars:/home/reva/to_chat"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏–º—Å—è –ª–∏ –º—ã –≤ git-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
if ! git rev-parse --is-inside-work-tree > /dev/null 2>&1; then
    echo "‚ùå –û—à–∏–±–∫–∞: –°–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω –≤–Ω—É—Ç—Ä–∏ Git-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è."
    exit 1
fi

echo "üì¶ –°–æ–±–∏—Ä–∞–µ–º –í–°–ï —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞ (–≤–∫–ª—é—á–∞—è –Ω–æ–≤—ã–µ/untracked) –≤ $RESULT_FILE..."

# –û—á–∏—â–∞–µ–º —Ñ–∞–π–ª, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
> "$RESULT_FILE"

# –ì–õ–ê–í–ù–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï:
# 1. git ls-files -> —Ñ–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –≤ –∏–Ω–¥–µ–∫—Å–µ
# 2. git ls-files --others --exclude-standard -> –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã, –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –≤ git (–Ω–æ –Ω–µ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º—ã–µ)
# sort | uniq -> —É–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã, –µ—Å–ª–∏ –≤–¥—Ä—É–≥ –±—É–¥—É—Ç
(git ls-files; git ls-files --others --exclude-standard) | sort | uniq | while read -r file; do
    
    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–∞–º —Ä–µ–∑—É–ª—å—Ç–∏—Ä—É—é—â–∏–π —Ñ–∞–π–ª, –µ—Å–ª–∏ –æ–Ω –≤–¥—Ä—É–≥ –ø–æ–ø–∞–ª –≤ —Å–ø–∏—Å–æ–∫
    if [ "$file" == "$RESULT_FILE" ]; then continue; fi

    # –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ —Ñ–∞–π–ª —Ç–µ–∫—Å—Ç–æ–≤—ã–π (–∏–ª–∏ –ø—É—Å—Ç–æ–π), –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ.
    # grep -Iq "" –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å—á–∏—Ç–∞–µ—Ç—Å—è –ª–∏ —Ñ–∞–π–ª –±–∏–Ω–∞—Ä–Ω—ã–º.
    if [ -f "$file" ] && grep -Iq "" "$file"; then
        echo "Processing: $file"
        echo "------------------------------------------------" >> "$RESULT_FILE"
        echo "FILE: $file" >> "$RESULT_FILE"
        echo "------------------------------------------------" >> "$RESULT_FILE"
        cat "$file" >> "$RESULT_FILE"
        echo -e "\n" >> "$RESULT_FILE"
    fi
done

echo "üöÄ –ü–µ—Ä–µ—Å—ã–ª–∫–∞ —Ñ–∞–π–ª–∞ –Ω–∞ $TARGET..."

# –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä mars
scp "$RESULT_FILE" "$TARGET"

if [ $? -eq 0 ]; then
    echo "‚úÖ –ì–æ—Ç–æ–≤–æ! –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω."
    # –£–¥–∞–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –∫–æ–ø–∏—é –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
    rm "$RESULT_FILE"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ scp."
fi
