#!/bin/bash

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–µ—Ä–µ–¥–∞–Ω–æ –ª–∏ –∏–º—è —Ñ–∞–π–ª–∞
if [ -z "$1" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –£–∫–∞–∂–∏—Ç–µ –∏–º—è —Ä–µ–∑—É–ª—å—Ç–∏—Ä—É—é—â–µ–≥–æ —Ñ–∞–π–ª–∞."
    echo "–ü—Ä–∏–º–µ—Ä: ./scripts/pack_and_send.sh project_context.txt"
    exit 1
fi

RESULT_FILE="$1"
TARGET="reva@mars:/home/reva/to_chat"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏–º—Å—è –ª–∏ –º—ã –≤ git-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
if ! git rev-parse --is-inside-work-tree > /dev/null 2>&1; then
    echo "‚ùå –û—à–∏–±–∫–∞: –°–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω –≤–Ω—É—Ç—Ä–∏ Git-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è."
    exit 1
fi

echo "üì¶ –°–æ–±–∏—Ä–∞–µ–º —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞ –≤ $RESULT_FILE..."

# –û—á–∏—â–∞–µ–º —Ñ–∞–π–ª, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
> "$RESULT_FILE"

# –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã, –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–µ Git
git ls-files | while read -r file; do
    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –±–∏–Ω–∞—Ä–Ω—ã–µ —Ñ–∞–π–ª—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–æ –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –ª–æ–≥–æ–≤)
    if [ -f "$file" ]; then
        echo "------------------------------------------------" >> "$RESULT_FILE"
        echo "FILE: $file" >> "$RESULT_FILE"
        echo "------------------------------------------------" >> "$RESULT_FILE"
        cat "$file" >> "$RESULT_FILE"
        echo -e "\n" >> "$RESULT_FILE"
    fi
done

echo "üöÄ –ü–µ—Ä–µ—Å—ã–ª–∫–∞ —Ñ–∞–π–ª–∞ –Ω–∞ $TARGET..."

# –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä mars
scp "$RESULT_FILE" "$TARGET"

if [ $? -eq 0 ]; then
    echo "‚úÖ –ì–æ—Ç–æ–≤–æ! –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω."
    # –£–¥–∞–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –∫–æ–ø–∏—é –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏, —á—Ç–æ–±—ã –Ω–µ –º—É—Å–æ—Ä–∏—Ç—å –≤ –ø—Ä–æ–µ–∫—Ç–µ
    rm "$RESULT_FILE"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ scp."
fi
