#!/bin/bash

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m' # No Color

CLI="./bin/ebusta-cli"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –±–∏–Ω–∞—Ä–Ω–∏–∫–∞
if [ ! -f "$CLI" ]; then
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞: –ë–∏–Ω–∞—Ä–Ω—ã–π —Ñ–∞–π–ª $CLI –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ 'make build'.${NC}"
    exit 1
fi

echo "üöÄ –ó–∞–ø—É—Å–∫ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö —Å–º–æ—É–∫-—Ç–µ—Å—Ç–æ–≤ —á–µ—Ä–µ–∑ ebusta-cli..."
echo "-----------------------------------------------------"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–∞
run_test() {
    local test_name="$1"
    local query="$2"
    local expected_pattern="$3"
    
    echo -n "üß™ –¢–µ—Å—Ç: $test_name ... "

    # –ó–∞–ø—É—Å–∫–∞–µ–º CLI –∏ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ–º –≤—ã–≤–æ–¥
    output=$($CLI "$query" 2>&1)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥ –≤–æ–∑–≤—Ä–∞—Ç–∞ (CLI –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å 0 –ø—Ä–∏ —É—Å–ø–µ—Ö–µ)
    if [ $? -ne 0 ]; then
         echo -e "${RED}[FAIL] (–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è CLI)${NC}"
         echo "   –í—ã–≤–æ–¥: $output"
         return 1
    fi

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ–∂–∏–¥–∞–µ–º–æ–π –ø–æ–¥—Å—Ç—Ä–æ–∫–∏ –≤ –≤—ã–≤–æ–¥–µ
    if echo "$output" | grep -q "$expected_pattern"; then
        echo -e "${GREEN}[PASS]${NC}"
        return 0
    else
        echo -e "${RED}[FAIL]${NC}"
        echo "   –ó–∞–ø—Ä–æ—Å: '$query'"
        echo "   –û–∂–∏–¥–∞–ª–æ—Å—å: '$expected_pattern'"
        echo "   –ü–æ–ª—É—á–µ–Ω–æ (–ø–µ—Ä–≤—ã–µ 3 —Å—Ç—Ä–æ–∫–∏):"
        echo "$output" | head -n 3
        return 1
    fi
}

# ==========================================
# 1. –ü—Ä–æ—Å—Ç–æ–π –ø–æ–∏—Å–∫ (Full Text)
# ==========================================
# –û–∂–∏–¥–∞–µ–º, —á—Ç–æ –≤ –±–∞–∑–µ –µ—Å—Ç—å —Ö–æ—Ç—å —á—Ç–æ-—Ç–æ, –ª–∏–±–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã
run_test "–ü—Ä–æ—Å—Ç–æ–π –ø–æ–∏—Å–∫ (–ö–∏–Ω–≥)" "–ö–∏–Ω–≥" "ID"

# ==========================================
# 2. –ü–æ–∏—Å–∫ –ø–æ –ø–æ–ª—é author
# ==========================================
run_test "–ü–æ–∏—Å–∫ –ø–æ –∞–≤—Ç–æ—Ä—É (author:)" "author:–ö–∏–Ω–≥" "ID"

# ==========================================
# 3. –ü–æ–∏—Å–∫ –ø–æ –ø–æ–ª—é title
# ==========================================
# –ò—â–µ–º —á—Ç–æ-—Ç–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä "–û–Ω–æ" –∏–ª–∏ "–¢—É–º–∞–Ω"
run_test "–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é (title:)" "title:–¢—É–º–∞–Ω" "ID"

# ==========================================
# 4. –°–ª–æ–∂–Ω—ã–π –∑–∞–ø—Ä–æ—Å (AND)
# ==========================================
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –ø–∞—Ä—Å–µ—Ä–∞ (Parser -> AST)
run_test "–°–ª–æ–∂–Ω—ã–π –∑–∞–ø—Ä–æ—Å (AND)" "author:–ö–∏–Ω–≥ AND title:–¢—É–º–∞–Ω" "ID"

# ==========================================
# 5. –°–º–µ—à–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç (–±–µ–∑ AND, –ø—Ä–æ—Å—Ç–æ —Å–ª–æ–≤–∞)
# ==========================================
# –≠—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç –ª–æ–≥–∏–∫—É –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ Processor
run_test "–°–º–µ—à–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å" "author:–ö–∏–Ω–≥ –¢—É–º–∞–Ω" "ID"

# ==========================================
# 6. –ü—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
# ==========================================
# –ò—â–µ–º –∑–∞–≤–µ–¥–æ–º–æ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ
run_test "–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—É—Å—Ç–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞" "author:NonExistentAuthorXYZ" "No results found"

# ==========================================
# 7. Debug Mode
# ==========================================
echo -n "üß™ –¢–µ—Å—Ç: –†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏ (DEBUG=1) ... "
debug_output=$(DEBUG=1 $CLI "test" 2>&1)
if [ $? -eq 0 ]; then
    echo -e "${GREEN}[PASS]${NC}"
else
    echo -e "${RED}[FAIL]${NC}"
fi

echo "-----------------------------------------------------"
echo "‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã."
