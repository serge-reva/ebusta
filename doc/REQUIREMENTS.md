# Software Requirements Specification (SRS) - Ebusta Pipeline

Данный документ определяет технические требования к каждому компоненту конвейера обработки сообщений системы Ebusta.

---

## 1. Web-Adapter (The Gateway)
**Роль:** Транспортный шлюз для внешних HTTP-запросов.

* **SR-1.1 (Interface):** Должен обеспечивать эндпоинт `GET /input?msg=...` для приема сырых данных.
* **SR-1.2 (Sanity Check):** Должен возвращать `HTTP 400 Bad Request`, если параметр `msg` пуст или отсутствует.
* **SR-1.3 (Source Identification):** Обязан при вызове следующего звена передавать метку `source: "web"`.
* **SR-1.4 (Logic Isolation):** **Запрещено** выполнять парсинг текста, поиск подстрок или любую бизнес-логику.
* **SR-1.5 (Error Handling):** Должен транслировать gRPC-статусы ошибок в соответствующие HTTP-коды (например, `Unavailable` -> `503 Service Unavailable`).

---

## 2. MessageConverter (The Semantic Brain)
**Роль:** Семантический разбор и нормализация сообщения.

* **SR-2.1 (Normalization):** Должен выполнять очистку входной строки (удаление лишних пробелов в начале/конце).
* **SR-2.2 (Intent Recognition):** Должен определять тип намерения (`Intent`) на основе командных префиксов:
    * `get ` или `download ` -> `intent: "download"`
    * Остальное -> `intent: "search"`
* **SR-2.3 (Payload Extraction):** Должен возвращать в поле `Payload` только содержательную часть, очищенную от командных префиксов.
* **SR-2.4 (Stateless):** Должен быть полностью "без состояния" (stateless) — результат парсинга зависит только от входной строки.
* **SR-2.5 (Robustness):** Должен корректно обрабатывать пустые строки после удаления префиксов, возвращая ошибку или дефолтный интент.

---

## 3. Processor (The Orchestrator)
**Роль:** Центр принятия решений и маршрутизации.

* **SR-3.1 (Routing):** Обязан выполнять маршрутизацию запроса строго на основе поля `Intent` из `UnifiedMessage`.
* **SR-3.2 (Service Coordination):**
    * При `search`: Вызывает `Data-Manager.Search()`.
    * При `download`: (Будущее) Вызывает `Download-Manager`.
* **SR-3.3 (Data Aggregation):** Должен упаковывать ответы от нижестоящих сервисов в единую структуру `ActionResponse`.
* **SR-3.4 (Resilience):** Должен использовать механизмы `Context Timeout` (не более 5 секунд на запрос) при обращении к другим сервисам.
* **SR-3.5 (Enrichment):** Имеет право добавлять метаданные к ответу (например, время обработки или статус выполнения).

---

## 4. Data-Manager (The Storage Interface)
**Роль:** Изолированный слой доступа к данным.

* **SR-4.1 (Contract Compliance):** Должен принимать только структурированные объекты `SearchRequest`.
* **SR-4.2 (Zero Context):** **Запрещено** иметь информацию об источниках запроса (TG/Web) или командах пользователя.
* **SR-4.3 (Data Consistency):** Должен возвращать консистентный список объектов `Book`, даже если найден только один результат.
* **SR-4.4 (Performance):** Должен обеспечивать быстрый поиск по индексу; в случае мока — имитировать задержку сети.
* **SR-4.5 (Safety):** Должен ограничивать максимальное количество возвращаемых записей (не более 50 за один запрос) для защиты памяти системы.

---

## Общие системные требования (Cross-Cutting)
1. **Communication:** Все межсервисное взаимодействие осуществляется исключительно через gRPC.
2. **Observability:** Каждый сервис обязан логировать факт получения запроса и результат его обработки через `logrus`.
3. **Graceful Shutdown:** Все компоненты должны корректно завершать работу по сигналу `SIGTERM`, закрывая активные соединения.

## 5. UnifiedMessage (The Internal Protocol)
**Роль:** Единый стандарт данных внутри системы.

* **SR-5.1 (Neutrality):** Объект не должен содержать специфичных для мессенджеров полей (например, `chat_id` или `irc_channel`). Вся метаинформация должна быть нормализована.
* **SR-5.2 (Intent Categorization):** Поле `Intent` должно быть строго типизировано (строка или enum), определяющее дальнейший путь сообщения:
    * `search` — запрос на поиск информации.
    * `download` — запрос на получение файла.
    * `help` — запрос системной справки.
    * `meta` — запрос статистики или информации о сервисе.
* **SR-5.3 (Payload Integrity):** Поле `Payload` обязано содержать только очищенные данные, готовые для передачи в поисковой движок без дополнительной обработки.
* **SR-5.4 (Traceability):** (Будущее) Должен содержать `CorrelationID` для отслеживания пути конкретного запроса через логи всех микросервисов.
* **SR-5.5 (Context Enrichment):** Должен включать поле `Source` (откуда пришел запрос), чтобы `Processor` мог принимать решение о лимитах (например, для Web-клиентов лимиты жестче, чем для CLI).
