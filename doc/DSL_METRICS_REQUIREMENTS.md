# DSL_METRICS_REQUIREMENTS.md

## 1. Цель
Обеспечить полную наблюдаемость (Observability) процесса парсинга DSL, выявить узкие места в производительности и отслеживать ошибки разбора в разрезе типов запросов.

## 2. Технический стек
* **Библиотека**: `prometheus.lisp` (cl-prometheus).
* **Экспозитор**: Встроенный HTTP-сервер на отдельном потоке (Hunchentoot).
* **Порт**: `50053` (эндпоинт `/metrics`).
* **Формат**: OpenMetrics / Prometheus text format.

## 3. Перечень метрик (SRE Golden Signals)

### 3.1. Трафик и Ошибки (Counters)
| Название метрики | Тип | Описание | Метки (Labels) |
| :--- | :--- | :--- | :--- |
| `dsl_requests_total` | Counter | Общее кол-во запросов | `status` (ok, error) |
| `dsl_errors_total` | Counter | Кол-во ошибок разбора | `error_type` (syntax, timeout, internal) |

### 3.2. Производительность (Histograms)
| Название метрики | Тип | Описание | Buckets |
| :--- | :--- | :--- | :--- |
| `dsl_parse_duration_seconds` | Histogram | Время обработки одного запроса | `.0001, .0005, .001, .002, .005, .01` |

### 3.3. Ресурсы (Gauges)
| Название метрики | Тип | Описание |
| :--- | :--- | :--- |
| `dsl_active_workers` | Gauge | Кол-во потоков, занятых парсингом в данный момент |
| `dsl_memory_usage_bytes` | Gauge | Текущий объем памяти, занятый Lisp-кучей (SBCL heap) |

## 4. Требования к реализации
1. **Thread Safety**: Изменение счетчиков метрик не должно приводить к блокировкам основного потока (использовать атомарные операции).
2. **Isolation**: Сбой в подсистеме метрик (например, зависание HTTP-порта) не должен влиять на работу gRPC.
3. **Efficiency**: Обновление метрик должно занимать менее **1%** от общего времени парсинга.


