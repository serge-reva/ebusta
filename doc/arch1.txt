# Архитектура книжного бота (Go, Telegram/IRC/CLI)

## Общая идея

Система состоит из набора микросервисов на Go, которые совместно реализуют книжного бота для Telegram, IRC и Linux CLI поверх личной библиотеки Ебуста. 
Метаданные книг хранятся в OpenSearch, файлы книг — в локальном файловом или объектном хранилище. Телега, ирк и CLI выступают фронтом, могут быть и другие
каналы доступа, например web.

## Компоненты

### TelegramAdapter

- Микросервис, реализующий интерфейс бота для Telegram.
- Принимает апдейты (Webhook или Long Polling), конвертирует входящие сообщения в `UnifiedMessage` и отправляет их в Processor.
- Получает от Processor ответы (текст, ссылки, файлы) и отправляет их в Telegram через Bot API.
- Отвечает за авторизацию по Bot Token, ограничения Telegram и обработку сетевых ошибок.

### IrcAdapter

- Микросервис‑клиент к IRC‑серверу.
- Подключается к IRC, подписывается на каналы и преобразует сообщения пользователей в `UnifiedMessage`, передавая их в Processor.
- Получает от Processor текстовые ответы и отправляет их в IRC‑каналы или приватные сообщения.
- Ограничен текстовым форматом и обычно возвращает ссылки на скачивание книги.

### CliAdapter (Linux CLI)

- Отдельный бинарь/микросервис, предоставляющий интерфейс командной строки для работы с тем же Processor.
- Может работать в двух вариантах:
  - Непосредственный CLI‑клиент, который по gRPC/HTTP обращается к Processor как к удалённому сервису.
  - Тонкий CLI, который отправляет команды в отдельный Gateway/CLI‑API сервис, а тот — в Processor.[web:63][web:68]
- Конвертирует команды пользователя (например, `book-bot search "Гарри Поттер" --format=fb2`) в `UnifiedMessage` и отправляет их в Processor.
- Получает от Processor ответы и отображает их в терминале (список книг, ссылки, статусы скачивания).

### Processor (Core)

- Центральный сервис с бизнес‑логикой.
- Принимает `UnifiedMessage` от всех адаптеров: TelegramAdapter, IrcAdapter, CliAdapter.
- Выполняет:
  - Разбор команд (/book, /author, /series, /random, выбор формата).
  - Обращения к Config‑Manager за конфигурацией (права, лимиты, форматы, тексты).
  - Обращения к Data‑Manager для поиска книг по метаданным в OpenSearch.[web:49][web:53]
  - Формирование ответа:
    - Списки найденных книг, варианты выбора.
    - Ссылки на скачивание или запросы к Book‑Fetcher для выдачи файла.
- Не зависит от конкретной платформы, работает с абстрактными входами/выходами.

### Data‑Manager (Search Service)

- Микросервис‑прокси к OpenSearch.
- Предоставляет API для поиска книг по:
  - Автору, названию, серии, жанру, языку.
  - Наличию форматов (fb2, epub, mobi и т.д.).
- Инкапсулирует построение запросов к OpenSearch, схему индексов и обработку ошибок/ретраев.[web:49][web:32]
- Возвращает объекты `BookMeta` с:
  - `bookId`, `title`, `authors`, `series`, `tags`.
  - Списком доступных форматов и файловых ключей.

### Config‑Manager

- Централизованный сервис конфигурации.
- Хранит:
  - Описание команд и алиасов.
  - Настройки под разные клиенты/ботов (Telegram, IRC, CLI): включённые функции, лимиты, формат вывода.
  - Локализацию и шаблоны ответов.[web:35][web:60]
- Предоставляет единый API (`GET /config/{clientType}/{botId}/{scope}/{key}`).
- Может использовать внутренний кеш и механизм hot‑reload.

### Book‑Fetcher

- Микросервис для выдачи файлов книг по ключу.
- API вида: `GET /books/{fileKey}?format=fb2|epub|mobi`.
- По `fileKey` и `format` находит файл в локальном хранилище (директория, NFS, объектное хранилище) и:
  - Либо отдаёт файл напрямую.
  - Либо возвращает одноразовую/подписанную ссылку для скачивания.[web:51][web:54]
- Не знает о Telegram/IRC/CLI и OpenSearch; работает только с файловым хранилищем.

### Хранилище

- **OpenSearch** — хранит метаданные книг и используется Data‑Manager’ом для поиска.[web:49]
- **Book Storage** — файловое или объектное хранилище (локальный диск, NFS, S3‑подобное), содержащее сами файлы книг.[web:54]

## Потоки данных

### Поиск книги

1. Пользователь инициирует команду:
   - В Telegram — через бот‑команду.
   - В IRC — через команду/префикс в канале.
   - В CLI — через команду в терминале (например, `book-bot search "Гарри Поттер"`).
2. Соответствующий адаптер (TelegramAdapter, IrcAdapter, CliAdapter) преобразует запрос в `UnifiedMessage` и отправляет в Processor.
3. Processor:
   - Запрашивает конфигурацию в Config‑Manager (лимиты, дефолтные форматы, тексты).[web:35]
   - Обращается к Data‑Manager для поиска книг в OpenSearch.[web:49]
4. Data‑Manager возвращает список `BookMeta` в Processor.
5. Processor формирует человекочитаемый ответ и отправляет его в соответствующий адаптер.
6. Адаптер отображает результат на стороне клиента (сообщение в Telegram/IRC или вывод в терминал).

### Получение книги

1. Пользователь выбирает книгу и формат (через команду/кнопку/флаги CLI).
2. Processor извлекает из `BookMeta` соответствующий `fileKey` и формат.
3. Processor обращается к Book‑Fetcher с параметрами `fileKey` и `format`.
4. Book‑Fetcher находит файл в Book Storage и либо:
   - Возвращает файл Processor (если нужно отдавать файл напрямую, например, в Telegram).
   - Либо возвращает ссылку, которую Processor отправляет пользователю.
5. Адаптер доставляет ссылку или файл до пользователя (сообщение, документ в Telegram или вывод URL в CLI).

## Разделение по слоям

- **Транспорт / фронты**:
  - TelegramAdapter
  - IrcAdapter
  - CliAdapter
- **Core‑логика**:
  - Processor
- **Backend‑сервисы**:
  - Data‑Manager
  - Config‑Manager
  - Book‑Fetcher
- **Хранилища**:
  - OpenSearch
  - Book Storage

Добавление CLI‑интерфейса не меняет core‑логику: он просто выступает ещё одним клиентом к Processor с тем же набором команд и сценариев. Решение должно
быть гибким, чтобы добавление нового фронта было максимально легким.

