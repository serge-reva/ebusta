# Архитектура системы "Eboost-Library" (v2.0)

## 1. Описание проблемы
[cite_start]Владельцы больших личных коллекций электронных книг часто сталкиваются с проблемой "мертвого груза": книги хранятся локально, но доступ к ним извне (с телефона, в дороге, для друзей) ограничен или неудобен[cite: 1, 3]. Существующие решения либо слишком тяжеловесны, либо привязаны к одному интерфейсу. [cite_start]Необходима система, которая абстрагирует хранилище и поиск, предоставляя единый доступ через разные каналы коммуникации с сохранением контекста пользователя[cite: 3, 39].

## 2. Предметная область (DDD Contexts)
Согласно принципам Domain-Driven Design, система разделена на следующие ограниченные контексты:
* [cite_start]**Interaction (Взаимодействие):** Трансформация специфичных протоколов (Telegram, IRC, CLI) в единый бизнес-язык системы `UnifiedMessage`[cite: 4, 14].
* [cite_start]**Identity & Access (Доступ):** Идентификация пользователей, проверка прав по Bot Token или белым спискам[cite: 6].
* [cite_start]**Library Core (Ядро):** Оркестрация процессов разбора команд, навигации и формирования ответов[cite: 14, 15].
* [cite_start]**Catalog (Каталог):** Полнотекстовый поиск и управление метаданными книг в OpenSearch[cite: 19, 21].
* [cite_start]**Delivery (Доставка):** Извлечение файлов из хранилища и предоставление ссылок или бинарных данных[cite: 25, 27].

## 3. Компоненты системы

### Слой адаптеров (Front-end)
* [cite_start]**TelegramAdapter:** Реализует интерфейс бота, обрабатывает Webhook/Long Polling[cite: 4].
* [cite_start]**IrcAdapter:** Микросервис-клиент для подключения к IRC-серверам и каналам[cite: 6, 7].
* [cite_start]**CliAdapter:** Интерфейс командной строки (Linux CLI) для удаленного обращения к ядру[cite: 10, 11].
* [cite_start]**Translator (New):** Компонент внутри адаптеров или перед процессором, преобразующий `RawPayload` в `UnifiedMessage`[cite: 30].

### Слой управления и состояния
* **Auth-Manager (New):** Проверяет UserID на наличие в Allow-листах или внешних провайдерах (Keycloak).
* **Session-Manager (New):** Прокси к **Redis** для хранения состояния поиска и текущего положения пользователя в каталоге.
* [cite_start]**Config-Manager:** Централизованный сервис для хранения лимитов, шаблонов ответов и локализации[cite: 22, 23].

### Слой бизнес-логики (Core)
* [cite_start]**Processor:** Центральный сервис, выполняющий разбор команд (/book, /author) и координирующий другие службы[cite: 14, 15, 17].

### Слой данных и хранилища
* [cite_start]**Data-Manager:** Прокси-сервис для построения запросов к **OpenSearch**[cite: 19, 21].
* [cite_start]**Book-Fetcher:** Сервис выдачи файлов по ключу из локального или объектного хранилища[cite: 25, 26, 28].

## 4. Потоки данных

### Поиск книги
1.  [cite_start]**Адаптер** (TG/IRC/CLI) принимает ввод и через **Translator** создает `UnifiedMessage`[cite: 30].
2.  **Auth-Manager** подтверждает права пользователя.
3.  [cite_start]**Processor** запрашивает метаданные у **Data-Manager**[cite: 31].
4.  **Processor** сохраняет ID результатов в **Session-Manager** (Redis) для поддержки пагинации.
5.  [cite_start]Формируется ответ и возвращается пользователю через соответствующий адаптер[cite: 32, 33].

### Получение файла
1.  [cite_start]Пользователь выбирает книгу и формат[cite: 34].
2.  [cite_start]**Processor** запрашивает файл или ссылку у **Book-Fetcher**[cite: 35, 36].
3.  [cite_start]**Book-Fetcher** обращается к **Book Storage** и возвращает результат[cite: 37, 38].

## 5. Структура проекта (Go Layout)
```text
.
├── cmd/                # Точки входа (main.go) для каждого адаптера
├── internal/           # Приватный код приложения
│   ├── domain/         # Чистые структуры (Book, User, UnifiedMessage)
│   ├── processor/      # Ядро (бизнес-сценарии)
│   ├── auth/           # Проверка прав и доступ
│   ├── session/        # Интеграция с Redis
│   ├── translator/     # Логика маппинга сообщений
│   ├── storage/        # Клиенты OpenSearch (Data-Manager) и FS (Fetcher)
│   └── config/         # Config-Manager и загрузка .env/yaml
├── pkg/                # Публичные библиотеки
├── api/                # Протоколы обмена (gRPC/Proto или OpenAPI)
└── deployments/        # Docker-compose и манифесты
