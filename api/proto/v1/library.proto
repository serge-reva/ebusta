syntax = "proto3";

package libraryv1;
option go_package = "ebusta/api/proto/v1;libraryv1";

import "common.proto";

// ==========================================
// 1. SERVICES
// ==========================================

service OrchestratorService {
  rpc Search (SearchRequest) returns (SearchResponse);
}

service ProcessorService {
  rpc Process (SearchRequest) returns (SearchResponse);
}

service StorageService {
  rpc SearchBooks (SearchRequest) returns (SearchResponse);
}
service MessageConverterService {
  rpc Convert (RawInput) returns (UnmarshaledMessage);
}

// Legacy
service LibraryService {
  rpc SearchBooks (SearchRequest) returns (SearchResponse);
  rpc GetAuthors (ListRequest) returns (ListResponse);
}

// ==========================================
// 2. MESSAGES
// ==========================================

message SearchRequest {
  string query = 1;
  string template_id = 2;
  int32 limit = 3;
  int32 offset = 4;
  string trace_id = 5;
  .ebusta.library.v1.SearchQuery ast = 6;
}

message SearchResponse {
  string status = 1;
  int32 total = 2;
  repeated Book books = 3;
}

message Book {
  string id = 1;
  string title = 2;
  repeated string authors = 3;
  string container = 4;
  string filename = 5;
}

message ListRequest {
  string query = 1;
}

message ListResponse {
  repeated string items = 1;
}

// --- AUTH ---
// ==========================================
// 3. CONVERTER & META (Fixed for existing code)
// ==========================================

message RawInput {
  // Исправлено: переименовано в 'data', чтобы появился метод GetData(), который ждет message-converter
  string data = 1;
  string trace_id = 2;
}

message MessageMeta {
  string trace_id = 1;
  string canonical_form = 2;
  string platform = 3;
  string user_id = 4;
  // Исправлено: добавлено поле, которое требует message-converter
  string ast_plan = 5;
}

message UnmarshaledMessage {
  MessageMeta meta = 1;
  .ebusta.library.v1.SearchQuery query = 2;
}

message Response {
  string status = 1;
  repeated Book books = 2;
  ResponseMeta meta = 3;
}

message ResponseMeta {
  string trace_id = 1;
  string canonical_form = 2;
}
